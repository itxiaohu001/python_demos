import os
import hashlib
import json


def calculate_file_hash(file_path, hash_algorithm='md5'):
    """计算文件的哈希值"""
    hash_obj = hashlib.md5() if hash_algorithm == 'md5' else hashlib.sha256()

    try:
        with open(file_path, 'rb') as f:
            # 分块读取大文件，避免内存问题
            for chunk in iter(lambda: f.read(4096), b""):
                hash_obj.update(chunk)
        return hash_obj.hexdigest()
    except Exception as e:
        print(f"计算文件 {file_path} 哈希值时出错: {e}")
        return None


def get_file_size(file_path):
    """获取文件大小（字节）"""
    try:
        return os.path.getsize(file_path)
    except Exception as e:
        print(f"获取文件 {file_path} 大小时出错: {e}")
        return 0


def process_directory(current_dir):
    result_list = []

    print(f"开始处理目录: {current_dir}")

    # 遍历当前文件夹下的所有子文件夹
    for item in os.listdir(current_dir):
        item_path = os.path.join(current_dir, item)

        # 只处理子文件夹，忽略文件
        if os.path.isdir(item_path):
            p1 = item  # 子文件夹名字作为p1

            print(f"处理子文件夹: {p1}")

            # 遍历子文件夹下的所有文件
            for root, dirs, files in os.walk(item_path):
                for file in files:
                    file_path = os.path.join(root, file)

                    # 计算文件哈希值
                    file_hash = calculate_file_hash(file_path)

                    if file_hash is not None:
                        # 获取文件大小
                        file_size = get_file_size(file_path)

                        # 构建结果对象
                        file_info = {
                            "hash": file_hash,
                            "size": file_size,
                            "threat": f"{p1}.{p1}.test",
                            "type": "file"
                        }

                        result_list.append(file_info)
                        print(f"处理文件: {file_path} -> 哈希: {file_hash}")

    return result_list


def main():
    """主函数"""
    try:
        # 处理目录并获取结果
        results = process_directory("E:\Downloads\malwares")

        # 输出统计信息
        print(f"\n处理完成！共找到 {len(results)} 个文件")

        # 保存为JSON文件
        output_file = "file_analysis_results.json"
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(results, f, indent=2, ensure_ascii=False)

        print(f"结果已保存到: {output_file}")

        # 显示前几个结果作为示例
        if results:
            print("\n前5个结果示例:")
            for i, result in enumerate(results):
                print(f"{i + 1}. {result}")

    except Exception as e:
        print(f"程序执行出错: {e}")


if __name__ == "__main__":
    main()